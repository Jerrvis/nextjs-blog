---
title: 浏览器输入url回车后发生了什么？
date: 2023-2-26 19:14:23
description: 前端面试0：浏览器输入url回车后发生了什么。该问题涉及到多方面的内容，包括网络的七层模型、浏览器缓存机制、tcp、udp、http/https、浏览器的渲染机制等。
tags:
  - interview
  - browser
---



## 1. 缓存查询

首先会去查询浏览器缓存或者本地缓存，查询是否有域名的dns记录，有就使用缓存直接向网址对应的ip发送请求

详细可查看我的文章：[浏览器的缓存机制](./browsercache)



## 2. 查看hosts映射

然后前往本地的hosts文件里查看是否有域名相关的映射

以我的win10为例具体路径为 `c:\Windows\System32\drivers\etc\HOSTS`

文件内容为如下

![image-20230301223216346](https://thumbsnap.com/i/vjHK1gkX.png)

这些github.com都是我自己手动设置的，也是为了更好地访问 github 设置了一些的ip，具体设置方法就不展开讲了，可自行百度。



## 3. dns解析



### 3.1 打包请求



如果hosts文件中也没有的话，浏览器会打包一个请求内容是**查询某度ip**，它会把请求发送到电脑中配置好的 dns 服务器 8.8.8.8

这个请求会由多层的网络协议封装，传输层添加一个随机端口，比如源端口:167 目标端口:53(dns通常使用53作为端口)，网络层添加ip(源ip:192.168.1.11 和目标ip: 8.8.8.8)，数据链路层添加MAC地址，AA-AA-AA-AA 发送给 CC-CC-CC-CC(以下简写为AA-CC)。



### 3.2 路由器转发公网



然后这个请求经过网关发送到局域网的路由器中，路由器通过MAC地址接收了这个请求后，查看到是发送给 8.8.8.8 ip，它会做一个转换将这个请求的源ip与端口 192.168.1.11:167 换成自己的公网ip与随机端口 : 172.12.34.56:857，并记录下映射 ( 172.12.34.56:857=> 192.168.1.11:167)，重新添加本机的公网源MAC地址(DD-DD-DD-DD)与它的下一个路由器地址(EE-EE-EE-EE 随便写的)，我们把它简写成这样子(DD-EE)，然后把请求发送到公网上。

### 3.3 公网转发

公网的EE的路由器接收到这个请求后，会修改源与目标MAC地址，改成EE-FF(FF为下一个路由器的地址)，经过不知道多少个路由器后变成了ZZ-FF来到了dns服务器

### 3.4  到达dns服务器

FF服务器看到是发给自己的请求，查看端口号是53(dns默认53端口)，然后dns服务器会进行dns解析，查到**某度的ip 是 11.11.11.11**，然后生成一个响应，源ip端口是 8.8.8.8:53，目标ip端口 172.12.34.56:857,原路返回。

### 3.5 返回到路由器

返回时同样经过多轮的MAC地址更换 最后变成EE-DD (EE发给DD)，来到了本地路由器(DD)。

### 3.6 路由器转换

路由器再次进行NAT转换 在记录的映射里找到 ip端口172.12.34.56:857是 发送给 192.168.1.11:167，转换后再次添加局域网MAC 地址与目标 MAC地址 CC-AA，然后这个响应经过交换机回到 电脑(AA)

### 3.7 得到ip地址

电脑查看是 8.8.8.8发送回来的，查看端口 167 是浏览器开的端口，就把信息发送到浏览器，浏览器查看信息到某度的ip 是 11.11.11.11.



## 4 向目标ip建立链接

与目标ip服务器使用tcp协议，三次握手建立连接。



## 5 发送http/https请求

三次握手之后，浏览器会发送请求，内容是**请把某度首页数据给我**，流程跟刚才向dns发送请求差不多只不过目标ip 换成某度的ip 11.11.11.11端口为80(此时浏览器并不知道该网址是否使用https，所以默认使用http 默认端口 80)。

当某度服务器80端口获取到你请求，以nginx为例，它会设置80端口重定向到443端口(https默认端口号)

我用 firefox 浏览器与bilibili.com测试(我很少用firefox)，我从没使用过firefox 浏览 bilibili.com，所以浏览器不知道要走https。

可以看到第一个请求走的http发生了301重定向到 https

![image-20230226214921104](https://thumbsnap.com/i/FmZW1mCe.png)

第二个请求才是走的https

![image-20230226215026057](https://thumbsnap.com/i/APz5xwtk.png)

然后我们再开一个页面再次打开bilibili.com

它直接走https了

![image-20230226215318867](https://thumbsnap.com/i/ShvnuCma.png)

接下来关闭所有页面，按下 ctrl + shift + h 删除掉bilibili的记录

![image-20230226215525329](https://thumbsnap.com/i/ARyXa59N.png)

重新打开 bilibili.com 浏览器又走的http了

![image-20230226215826544](https://thumbsnap.com/i/RB8ZJrmp.png)



## 6 服务器处理请求并返回http报文

服务器收到请求后会发出应答，即响应数据。HTTP响应与HTTP请求相似， HTTP响应报文格式：状态行+响应头+空行+消息体，状态行包括HTTP版本号、状态码、状态说明。



## 7 浏览器解析渲染页面

浏览器拿到响应文本后，解析HTML代码，请求js，css等资源，最后进行页面渲染，呈现给用户。页面渲染一般分为以下几个步骤：

(1)根据HTML文件解析出DOM Tree

(2)根据CSS解析出 CSSOM Tree(CSS规则树)

(3)将 DOM Tree 和 CSSOM Tree合并，构建Render tree(渲染树)

(4)reflow(重排)：根据Render tree进行节点信息计算(Layout)

(5)repaint(重绘)：根据计算好的信息绘制整个页面(Painting)

因为 html 是一个树形结构，浏览器根据这个 html 来构建 DOM 树，在 dom 树的构建过程中如果遇到 JS 脚本和外部 JS 连接，则会停止构建 DOM 树来执行和下载相应的代码，这会造成阻塞，这就是为什么推荐 **JS 代码应该放在 html 代码的后面**。





## 8 TCP四次挥手

当数据传输完毕，需要断开TCP连接，此时发起tcp四次挥手

第一次挥手是浏览器发完数据后，发送FIN请求断开连接。

第二次挥手是服务器发送ACK表示同意

第三次挥手是服务器发送FIN，表示现在关闭

这样浏览器需要返回ACK表示同意，也就是第四次挥手。



面试官追问：

1. 网页的缓存机制
2. 七层网络协议是什么
3. http/https 相关问题
4. 浏览器渲染机制
5. 回流与重绘